version: 2

models:
  - name: int_citibike__joined_errors_extracted
    description: "This model dynamically combines Citibike bronze staging tables into a single table. EXCLUDES ERRORS."
    data_tests:
      # Test that error rate is under 1%
      - dbt_utils.expression_is_true:
          expression: "data_quality_error_rate < 1.0"
          config:
            severity: error  # This will FAIL the build
      # Test data integrity on clean dataset
      - dbt_utils.expression_is_true:
          expression: "ended_at >= started_at"
          config:
            severity: error
      - dbt_utils.expression_is_true:
          expression: "end_station_name IS NULL AND end_station_id IS NOT NULL"
          config:
            severity: error
            
    columns:
      - name: ride_id
        description: "Primary key: Unique ride identifier"
        data_tests:
          - unique: 
              config:
                severity: error
          - not_null:
              config:
                severity: error

      - name: started_at
        description: "Trip start timestamp"
        data_tests:
          - not_null:
              config:
                severity: warn

      - name: data_quality_error_rate
        description: "Percentage of rows that failed validation"
        data_tests:
          - not_null:
              config:
                severity: warn
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              config:
                severity: warn

  - name: int_citibike__joined_errors_only
    description: "This model dynamically combines Citibike bronze staging tables into a single table. INCLUDES ONLY ERRORS."
    columns:
        - name: ride_id
          description: "Primary key: Unique ride identifier"
          data_tests:
            - unique:
                config:
                  severity: error
            - not_null:
                config:
                  severity: error
        - name: error_reason
          description: "Reason for data quality failure"
          data_tests:
            - not_null:
                config:
                  severity: warn
        - name: source_model
          description: "Source model where error occurred"
          data_tests:
            - not_null:
                config:
                  severity: warn

  - name: int_citibike__joined_with_data_typing
    description: "This model dynamically combines Citibike bronze staging tables into a single table."
    data_tests:
      # Test data integrity on clean dataset
      - dbt_utils.expression_is_true:
          expression: "ended_at >= started_at"
          config:
            severity: warn
      - dbt_utils.expression_is_true:
          expression: "end_station_name IS NULL AND end_station_id IS NOT NULL"
          config:
            severity: warn
            
    columns:
      - name: ride_id
        description: "Primary key: Unique ride identifier"
        data_tests:
          - unique:
              config:
                severity: error
          - not_null:
              config:
                severity: error

      - name: started_at
        description: "Trip start timestamp"
        data_tests:
          - not_null:
              config:
                severity: warn
  