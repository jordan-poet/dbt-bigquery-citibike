version: 2

models:
  - name: int_citibike_all_clean
    description: "Bronze to Silver citibike data with data quality validation"
    data_tests:
      # Test that error rate is under 1%
      - dbt_utils.expression_is_true:
          expression: "data_quality_error_rate < 1.0"
          config:
            severity: error  # This will FAIL the build
      # Test data integrity on clean dataset
      - dbt_utils.expression_is_true:
          expression: "ended_at IS NULL OR ended_at >= started_at"
          config:
            severity: error
      - dbt_utils.expression_is_true:
          expression: "end_station_name IS NULL OR end_station_id IS NOT NULL"
          config:
            severity: error
            
    columns:
      - name: ride_id
        description: "Primary key: Unique ride identifier"
        data_tests:
          - not_null:
              config:
                severity: error

      - name: started_at
        description: "Trip start timestamp"
        data_tests:
          - not_null:
              config:
                severity: error

      - name: data_quality_error_rate
        description: "Percentage of rows that failed validation"
        data_tests:
          - not_null:
              config:
                severity: error
          - dbt_utils.accepted_range:
              min_value: 0
              max_value: 1
              config:
                severity: error

  - name: int_citibike_all_errors
    description: "All rows that failed data quality checks"
    columns:
        - name: error_reason
          description: "Reason for data quality failure"
          data_tests:
            - not_null:
                config:
                  severity: warn
        - name: source_model
          description: "Source model where error occurred"
          data_tests:
            - not_null:
                config:
                  severity: warn